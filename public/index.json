


[{"content":"","date":"30 October 2024","externalUrl":null,"permalink":"/","section":"louigi.tech","summary":"","title":"louigi.tech","type":"page"},{"content":"","date":"30 October 2024","externalUrl":null,"permalink":"/posts/","section":"Posts","summary":"","title":"Posts","type":"posts"},{"content":"\rThis article has been translated in English with the help of ChatGPT\rüì¢ Introduction #\rWhether in your homelab or in a production environment, you\u0026rsquo;ve likely encountered this message on your first connection to your Proxmox host:\nBy default, the Proxmox web interface comes with a self-signed certificate. Fortunately for us, the latest versions of Proxmox natively support ACME DNS challenges!\nIn this article, I will explain in detail all the steps necessary to set up a Let\u0026rsquo;s Encrypt certificate using a DNS challenge.\nNote that this procedure was carried out using an Infomaniak API token, as my domain is hosted with them. However, the procedure should work for other providers as well; you‚Äôll just need to adapt the settings accordingly.\nüîç Prerequisites #\r3 things to check:\n‚úÖ An A record on your local DNS server(s) ‚Üí Mine points to minastirith.gattabru.si\n‚úÖ Public domain name ‚Üí In my case, gattabru.si\n‚úÖ Compatible registrar ‚Üí Domain hosted with Infomaniak\n‚ûï Pros #\rNo need to expose ports 80 and 443 to the Internet No need for A or CNAME records pointing to your public IP address Therefore, enhanced security ‚ûñ Cons #\rA public domain name is required Your registrar must support the DNS challenge (list here) Complexity of setup (although, once you understand it, it\u0026rsquo;s fairly straightforward) ‚öôÔ∏è Setup #\rüõ†Ô∏è ACME Accounts #\rWe\u0026rsquo;ll start by setting up not one but two ACME accounts on our host, here‚Äôs why:\nA staging account in the Let's Encrypt V2 Staging directory, which will be used to validate that our ACME configuration is correct. This allows for debugging and error correction without hitting the rate limit described below, which could otherwise result in account blocking.\nThe other is a produduction account in the Let's Encrypt V2 directory. Once configuration is validated, we‚Äôll switch to this account to obtain our final certificate.\nThe limit is 5 failures per account, per hostname, per hour in the Let's Encrypt V2 directory.\rTo create the first account in the Let's Encrypt V2 Staging directory, go through the following menus:\nDatacenter ACME Click Add to add a new account Fill in the information and be sure to choose the Let's Encrypt V2 Staging directory. Don‚Äôt forget to accept the Terms of Service (TOS). Repeat steps 3 and 4 for the Let's Encrypt V2 directory: With both accounts created, we‚Äôll now create an API token from our registrar to enable the DNS challenge.\nü™ô API Token (Infomaniak) #\rThis step will vary depending on your domain provider. Since my domain is with Infomaniak, I‚Äôll show you how it‚Äôs done on their platform. Generally, a quick Google search will provide guidance:\nGandi OVH If your domain is with Infomaniak like mine, log into your manager and create a new token. Go to the top left in the Users and Profile section: Next, select My profile \u0026gt; Developer \u0026gt; puis finalement API Tokens to access your token management console. In this console, we‚Äôll create a new token:\nFill in the required information, then create your token. Be sure to limit the token scope to domain - Produits Noms de domaine. It‚Äôs strongly recommended not to set the scope to \u0026ldquo;All\u0026rdquo; for obvious security reasons. Think of the consequences if your token were to be compromised.\nYour token is now created:\nOnce created, copy your token and store it securely, such as in a password manager.\rAs noted, you won‚Äôt be able to view the token again once you close this page. If you forget to copy it, you can always delete it and generate a new one.\nNow that we have our token, limited to the required scope, we can return to our Proxmox host to continue configuration.\nüîß Challenge plugin #\rIn the same ACME menu, go to the Challenge Plugin section and click Add to add a new plugin: Some explanations:\nPlugin ID is the name you‚Äôd like to give to your plugin. I recommend keeping it consistent, without spaces.\nValidation Delay is the time in seconds between creating your DNS record via the API and when the ACME provider is asked to validate it. I recommend keeping this parameter default, adjusting it later if the validation period is too short.\nDNS API : Who your registrar is. Depending on your selection, the section below will request different information. Example with Cloudflare: We can clearly see that we don\u0026rsquo;t have the same parameters as Infomaniak\rAPI DATA : Your API parameters, such as your token, TTL, etc.\nThe API DATA parameters depend on your registrar and vary between providers.\rSince my registrar is Infomaniak, I‚Äôll consult the documentation directly on the go-acme.github.io website: The parameters listed under Credentials are mandatory. The others under Additional Configuration are optional but very helpful for validation (we‚Äôll cover this below).\nCAUTION: If your domain is with Infomaniak, the INFOMANIAK_ACCESS_TOKEN parameter won‚Äôt work with Proxmox.\nReplace it with INFOMANIAK_API_TOKEN (as shown below); otherwise, you‚Äôll encounter the error described later in this article.\nNow that we know all our parameters, we can enter them in the API DATA field on our Proxmox host:\nAs shown, I‚Äôve replaced INFOMANIAK_ACCESS_TOKEN with INFOMANIAK_API_TOKEN. There‚Äôs no need to enclose your token in quotes.\nI\u0026rsquo;ve also added INFOMANIAK_PROPAGATION_TIMEOUT and INFOMANIAK_TTL. both set to 300 seconds. This means validation will timeout after 5 minutes if it fails, and the TTL for our record will also be 5 minutes.\nThe DNS challenge configuration is complete, and we can now generate our certificates!\nüìú Certificates creation #\rIf you‚Äôre familiar with the DNS challenge, you can skip to the production certificate generation.\nOtherwise, I suggest testing with the staging account to avoid hitting the the rate limits mentioned above.\nOnce the staging configuration is validated, we‚Äôll switch to the production account.\nüß™ Staging certificate #\rFor this, go to the Certificates tab of your host (Hostname \u0026gt; System \u0026gt; Certificates).\nThen switch the ACME account to Staging:\nWe can now create a new certificate via the Add button on this page:\nSpecify a Challenge Type of DNS, select our previously created plugin, and enter the name of our DNS record.\nOnce the fields are filled out, finalize the certificate creation with the Create button, then order it with Order Certificates Now.\nIf everything goes well, you should see the following result:\nThe Proxmox web interface will then reload with the new certificate you generated:\nAt this stage, it‚Äôs still normal to see a warning message. The Let's Encrypt V2 Staging directory does not issue certificates from a trusted authority recognized by your browser.\rüè≠ Production certificate #\rWith our configuration validated, we can generate our final certificate. Switch to your ACME_PRODaccount to use the Let's Encrypt V2 directory, then order your certificate via the Order Certificates Now button:\nAgain, if everything proceeds smoothly, a temporary _acme-challenge TXT record should appear in your DNS zone, with a TTL of 5 minutes as specified in the INFOMANIAK_TTL parameter of our ACME DNS Plugin :\nThe result of your request should be similar to that in the Let's Encrypt V2 Staging directory:\nFinally, the Proxmox web interface should reload with your new Let\u0026rsquo;s Encrypt certificate in place:\nüé¨ Conclusion #\rWe‚Äôve covered the steps to secure the Proxmox web interface with a signed certificate.\nCertificate renewal will occur automatically by default, 30 days before expiration. In case of renewal issues, Let‚Äôs Encrypt will email you at the addresses you provided in your ACME accounts.\nIf you encounter any issues, feel free to check the Troubleshooting section. Otherwise, there\u0026rsquo;s only one thing left to do\u0026hellip; Party tiiiime!!\n‚ùå Troubleshooting #\rüí° Infomaniak API Token #\rYou followed the documentation on the go-acme.github.io website for your domain at Infomaniak but received the following error message:\nPlease provide a valid Infomaniak API token in variable INFOMANIAK_API_TOKEN And the configuration of your ACME DNS Plugin looks like this:\nThe answer is in the error message. It indicates that it expects a variable with the value INFOMANIAK_API_TOKEN. For some reason, on Proxmox, this parameter needs to be named INFOMANIAK_API_TOKEN instead of INFOMANIAK_ACCESS_TOKEN.\nIn the end, it‚Äôs a simple fix. Go back to your ACME DNS Plugin configuration and change the parameter name from INFOMANIAK_ACCESS_TOKEN to INFOMANIAK_API_TOKEN:\nüí° Incorrect Certificate #\rIt may happen that during the production certificate generation, your browser continues to display a warning regarding your certificate, even though it is indeed the Let\u0026rsquo;s Encrypt certificate from the Let's Encrypt V2 directory:\nFirst, check that your production certificate has indeed been applied.\nIf it has, there‚Äôs a high chance that your browser‚Äôs cache is causing the issue. Try restarting your browser, and if that doesn‚Äôt work, clear its cache and restart it again.\nThis should resolve the issue üòâ!\nüí° ACME Validation #\rI haven\u0026rsquo;t encountered this with Proxmox yet, but it can happen.\nYour ACME DNS Plugin configuration is correct since there are no specific errors during the certificate request, yet the ACME validation fails due to a timeout.\nHere are a few troubleshooting tips:\nAdjust the Validation Delay and/or INFOMANIAK_PROPAGATION_TIMEOUT parameters in your ACME DNS Plugin: Temporarily change your host‚Äôs DNS settings: ","date":"30 October 2024","externalUrl":null,"permalink":"/posts/proxmox-dns-challenge/","section":"Posts","summary":"This article has been translated in English with the help of ChatGPT\rüì¢ Introduction #\rWhether in your homelab or in a production environment, you\u0026rsquo;ve likely encountered this message on your first connection to your Proxmox host:","title":"Proxmox: Let's Encrypt Certificate with DNS Challenge","type":"posts"},{"content":"","date":"30 October 2024","externalUrl":null,"permalink":"/tags/system/","section":"Tags","summary":"","title":"System","type":"tags"},{"content":"","date":"30 October 2024","externalUrl":null,"permalink":"/tags/","section":"Tags","summary":"","title":"Tags","type":"tags"},{"content":"","externalUrl":null,"permalink":"/authors/","section":"Authors","summary":"","title":"Authors","type":"authors"},{"content":"","externalUrl":null,"permalink":"/categories/","section":"Categories","summary":"","title":"Categories","type":"categories"},{"content":"","externalUrl":null,"permalink":"/series/","section":"Series","summary":"","title":"Series","type":"series"}]