


[{"content":"","date":"30 octobre 2024","externalUrl":null,"permalink":"/fr/","section":"louigi.tech","summary":"","title":"louigi.tech","type":"page"},{"content":"","date":"30 octobre 2024","externalUrl":null,"permalink":"/fr/posts/","section":"Posts","summary":"","title":"Posts","type":"posts"},{"content":"\rüì¢ Introduction #\rQue ce soit dans votre homelab ou dans un environnement de production, vous √™tes forc√©ment tomber sur ce message √† la premi√®re connexion de votre h√¥te Proxmox :\nPar d√©faut, l\u0026rsquo;interface web de Proxmox est livr√©e avec un certificat auto-sign√©. Heureusement pour nous, les derni√®res versions de Proxmox supportent nativement les challenges ACME DNS !\nDans cet article, je vais vous expliquer de mani√®re d√©taill√©e, toutes les √©tapes n√©cessaires √† la mise en place d\u0026rsquo;un certificat Let\u0026rsquo;s Encrypt avec un challenge DNS.\nIl faut savoir que la proc√©dure a √©t√© r√©alisation avec un token d\u0026rsquo;API Infomaniak puisque mon domaine est chez eux. Toutefois, la proc√©dure devrait fonctionner pour les autres fournisseurs, il vous suffira d\u0026rsquo;adapter les param√®tres en fonction.\nüîç Pr√©requis #\r3 choses :\n‚úÖ Un enregistrement de type A sur votre / vos DNS locaux ‚Üí Le mien pointe vers minastirith.gattabru.si ‚úÖ Nom de domaine public ‚Üí Dans mon cas gattabru.si\n‚úÖ Registrar compatible ‚Üí Domaine chez Infomaniak\n‚ûï Avantages #\rPas besoin d\u0026rsquo;exposer les ports 80 et 443 sur Internet Pas besoin d\u0026rsquo;enregistrement A ou CNAME qui pointe vers votre adresse IP publique Par cons√©quent, renforcement de la s√©curit√© ‚ûñ Incov√©nients #\rNom de domaine public obligatoire Votre registrar doit √™tre compatible avec le challenge DNS (la liste ici) Complexit√© de mise en place (et encore, une fois que vous avez compris c\u0026rsquo;est assez simple) ‚öôÔ∏è Mise en place #\rüõ†Ô∏è Comptes ACME #\rOn va commencer par d√©clarer non pas un mais deux comptes ACME sur notre h√¥te, voici pourquoi :\nUn compte de staging sur le directory Let's Encrypt V2 Staging qui nous servira √† valider que notre configuration ACME est correcte. En cas de probl√®me on pourra d√©bugger et corriger nos erreurs, sans atteindre la limite d√©crite plus bas et donc, de se retrouver bloqu√©.\nL\u0026rsquo;autre compte de produduction sur le directory Let's Encrypt V2. Une fois la configuration valid√©e, on baculera sur ce compte pour obtenir notre certificat final.\nLa limite est de 5 √©checs par compte, par nom d\u0026rsquo;h√¥te, par heure sur le directory Let's Encrypt V2.\rPour cr√©er les premier compte sur le directory Let's Encrypt V2 Staging, rendez-vous dans les menus suivants :\nDatacenter ACME Appuyez sur le bouton Add, afin d\u0026rsquo;ajouter un nouveau compte Renseignez les infos et choisissez bien le directory Let's Encrypt V2 Staging. N\u0026rsquo;oubliez pas √©galement d\u0026rsquo;accepter les conditions de service (TOS). Vous pouvez r√©p√©ter les √©tapes 3 et 4 pour le directory Let's Encrypt V2 : Nos deux comptes sont cr√©√©s, nous allons d√©sormais cr√©er un token sur l\u0026rsquo;API de notre registrar pour le fonctionnement de notre challenge DNS.\nü™ô Token API (Infomaniak) #\rCette action va vraiment d√©pendre du fournisseur de votre nom de domaine. Le mien √©tant chez Infomaniak, je vais vous montrer comment faire sur leur plateforme. En g√©n√©ral, quelques recherches Google et vous avez votre r√©ponse :\nGandi OVH Si comme moi, votre domaine est chez Infomaniak, connectez-vous sur votre manager et cr√©ez un nouveau token. Rendez-vous en haut √† gauche dans la section Utilisateurs et profil : Choisissez ensuite Mon profil \u0026gt; D√©veloppeur \u0026gt; puis finalement Tokens API pour arriver sur la console de gestion de vos tokens. Sur cette console, on va cr√©er un nouveau token :\nRenseignez les diverses informations puis cr√©ez votre token. Limitez bien le scope de votre token uniquement aux domain - Produits Noms de domaine. Je vous d√©conseille vivement de mettre le scope sur \u0026ldquo;Tous\u0026rdquo;, pour des questions √©videntes de s√©curit√©. Pensez aux cons√©quences si votre token viendrait √† √™tre compromis.\nVotre token est d√©sormais cr√©√© :\nUne fois votre token cr√©√©, copiez-le et stockez le dans un endroit s√ªr tel qu\u0026rsquo;un gestionnaire de mot de passe.\rComme indiqu√©, une fois cette page ferm√©e, il ne sera plus possible de voir le token. Dans le cas ou vous auriez oubli√© de le copier, vous pouvez toujours supprimer celui-ci et en g√©n√©rer un nouveau.\nVoila, notre token est cr√©√© et il est limit√© uniquement au scope dont nous avons besoin, on peut retouner sur notre h√¥te Proxmox pour la suite de la configuration.\nüîß Challenge plugin #\rToujours dans le m√™me menu ACME, dans la section Challenge Plugin, appuyez sur Add pour ajouter un plugin : Quelques explications :\nPlugin ID est le nom que vous souhaitez donner √† votre plugin. Je vous conseil de garder un nom coh√©rent, sans espaces.\nValidation Delay est le temps en secondes entre la cr√©ation de votre enregistrement DNS via l\u0026rsquo;API et le moment o√π le fournisseur d\u0026rsquo;ACME est invit√© √† le valider. Je vous conseil de laisser ce param√®tre par d√©faut et jouer avec plus tard, dans le cas ou ce d√©lais serait trop court pour la validation de votre enregistrement.\nDNS API : Qui est votre registrar. Selon votre choix, la section du dessous ne vous demandera pas les m√™mes infos. Exemple avec Cloudflare : On peut clairement voir que nous n\u0026rsquo;avons pas les m√™mes param√®tres qu\u0026rsquo;Infomaniak\rAPI DATA : Vos param√®tres API tels que votre token, le TTL de votre enregistrement \u0026hellip;\nLes param√®tres API DATA d√©pendent de votre registrar et ne sont pas les m√™mes d\u0026rsquo;un registrar √† un autre.\rMon registrar est Infomaniak, je vais donc consulter la documentation directement sur le site de go-acme.github.io : Les param√®tres renseign√©s sous Credentials sont obligatoires. Les autres sous Additional Configuration, ne le sont pas mais sont tr√®s pratiques afin d\u0026rsquo;obtenir la validation (on verra √ßa un peu plus bas).\nATTENTION : Si votre domaine est chez Infomaniak, le param√®tre INFOMANIAK_ACCESS_TOKEN n\u0026rsquo;est pas bon sous Proxmox\u0026hellip;\nIl faut le remplacer par le param√®tre nomm√© INFOMANIAK_API_TOKEN (comme la photo ci-dessous) sinon, vous allez finir avec l\u0026rsquo;erreur d√©crite en bas d\u0026rsquo;article.\nOn connait donc l\u0026rsquo;ensemble de nos param√®tres, on peut donc les renseigner dans le champ API DATA sur notre h√¥te Proxmox :\nComme vous pouvez le constater, j\u0026rsquo;ai bien remplac√© le param√®tre INFOMANIAK_ACCESS_TOKEN par INFOMANIAK_API_TOKEN. Nul besoin de mettre votre token entre guillemets ou apostrophes.\nJe rajoute √©galement les param√®tres INFOMANIAK_PROPAGATION_TIMEOUT et INFOMANIAK_TTL. Ces deux valeurs sont √† 300 (secondes) afin d\u0026rsquo;indiquer que la validation s\u0026rsquo;arr√™tera au bout de 5 minutes si elle √©choue, et le Time To Live (TTL) de notre enregistrement sera √©galement de 5 minutes.\nLa configuration de notre challenge DNS est termin√©e, on peut d√©sormais g√©n√©rer nos certificats !\nüìú G√©n√©ration des certificats #\rSi vous √™tes √† l\u0026rsquo;aise avec le challenge DNS, vous pouvez directement pass√© √† la g√©n√©ration du certificat de production.\nSinon, je vous propose de faire vos tests avec le compte de staging, afin de ne pas atteindre les limitations cit√©es plus haut.\nUne fois notre configuration de staging valid√©e, on basculera sur le compte de production.\nüß™ Certificat de staging #\rPour cela, rendez-vous dans l\u0026rsquo;onglet Certificates de votre h√¥te (Nom de votre h√¥te \u0026gt; System \u0026gt; Certificates).\nPuis basculez le compte ACME sur celui de Staging :\nOn peut d√©sormais cr√©er un nouveau certificat via le bouton Add de cette m√™me page :\nOn vient bien lui sp√©cifier un Challenge Type DNS, venir s√©lectionner notre plugin pr√©c√©dement cr√©√© puis on renseigne le nom de notre enregistrement DNS.\nUne fois les champs remplis, on vient finaliser la cr√©ation de notre certificat avec le bouton Create puis on lance la commande de celui-ci avec le bouton Order Certificates Now.\nSi tout se d√©roule bien, vous devriez avoir le r√©sultat suivant :\nL\u0026rsquo;interface web Proxmox va alors se recharger avec le nouveau certificat que vous venez de g√©n√©rer :\nPour le moment, il est encore normal d\u0026rsquo;avoir un message d\u0026rsquo;alerte. Le directory Let's Encrypt V2 Staging ne g√©n√®re pas de certificats issus d\u0026rsquo;une authorit√© de certification de confiance et connue par votre navigateur.\rüè≠ Certificat de production #\rNotre configuration est donc correcte, on peut g√©n√©rer notre certificat final. Pour cela, basculez sur votre compte ACME ACME_PROD afin d\u0026rsquo;√™tre sur le directory Let's Encrypt V2. Puis commandez votre certificat via le bouton Order Certificates Now :\nUne nouvelle fois, si tout se passe bien, un enregistrement temporaire de type TXT qui commence par _acme-challenge devrait apparaitre dans votre zone DNS. Celui-ci a bien TTL de 5 minutes comme indiqu√© dans le param√®tres INFOMANIAK_TTL de notre ACME DNS Plugin :\nLe r√©sultat de votre commande devrait √™tre identique √† celle sur le directory Let's Encrypt V2 Staging :\nEt finalement, l\u0026rsquo;interface web Proxmox devrait se recharger avec votre nouveau certificat Let\u0026rsquo;s Encrypt en place :\nüé¨ Conclusion #\rNous avons pu voir ensemble les diverses √©tapes afin de sign√© l\u0026rsquo;interface graphique de notre h√¥te Proxmox.\nLe renouvellement de votre certificat s\u0026rsquo;effectuera par d√©faut tout seul, 30 jours avant sa date d\u0026rsquo;expiration. En cas de probl√®me de renouvellement, vous revevrez un mail de Let\u0026rsquo;s Encrypt sur le / les adresses mail que vous avez renseign√©es dans vos comptes ACME.\nEn cas de probl√®me n\u0026rsquo;h√©sitez pas √† jeter un coup d\u0026rsquo;oeil √† la section Probl√®mes et r√©solutions. Sinon, il y a plus qu\u0026rsquo;une chose √† faire\u0026hellip; Ap√©√©√©√©√©ro !\n‚ùå Probl√®mes et r√©solutions #\rüí° Infomaniak API token #\rVous avez suivi la documentation du site de go-acme.github.io pour votre domaine chez Infomaniak mais vous obtenez ce message d\u0026rsquo;erreur :\nPlease provide a valid Infomaniak API token in variable INFOMANIAK_API_TOKEN Et la configuration de votre ACME DNS Plugin resemble √† cela :\nAlors la r√©ponse est dans le message d\u0026rsquo;erreur. En fait le message nous indique clairement qu\u0026rsquo;il attend une variable avec la valeur INFOMANIAK_API_TOKEN. Pour une raison que j\u0026rsquo;ignore, sur Proxmox ce param√®tre doit √™tre nomm√© INFOMANIAK_API_TOKEN au lieu de INFOMANIAK_ACESS_TOKEN.\nAu final, rien de bien m√©chant. Retournez sur la configuration de votre ACME DNS Plugin puis changez le nom de la valeur INFOMANIAK_ACESS_TOKEN en INFOMANIAK_API_TOKEN :\nüí° Mauvais certificat #\rIl se peut que lors de la g√©n√©ration du certificat de production, votre navigateur continu √† vous afficher une alerte concernant votre certificat malgr√© que ce soit bien celui de Let\u0026rsquo;s Encrypt sur le directory Let's Encrypt V2 :\nBon dans un premier temps, v√©rifiez que votre certificat de production a bien √©t√© pris en compte.\nSi c\u0026rsquo;est le cas, il y a de grandes chances pour que ce soit le cache de votre navigateur qui vous pose probl√®me. Je vous invite √† relancer votre navigateur et si cela ne suffit pas, vous pouvez effacer le cache de celui-ci et le relancer √† nouveau.\nCela devrait r√©soudre votre probl√®me üòâ !\nüí° Validation ACME #\rJe n\u0026rsquo;ai pas encore eu le cas avec Proxmox mais je pense que cela peut arriver.\nLa configuration de votre ACME DNS Plugin est correcte puisque vous n\u0026rsquo;avez pas d\u0026rsquo;erreur particuli√®re lors de la commande de votre certificat mais pourtant, la validation ACME √©choue car elle a d√©pass√© le temps imparti pour la validation (Timeout).\nQuelques pistes pour vous aider :\nVenir jouer avec les valeurs des param√®tres Validation Delay et / ou INFOMANIAK_PROPAGATION_TIMEOUT de votre ACME DNS Plugin : Changez provisoirement les DNS de votre h√¥te : ","date":"30 octobre 2024","externalUrl":null,"permalink":"/fr/posts/proxmox-dns-challenge/","section":"Posts","summary":"üì¢ Introduction #\rQue ce soit dans votre homelab ou dans un environnement de production, vous √™tes forc√©ment tomber sur ce message √† la premi√®re connexion de votre h√¥te Proxmox :","title":"Proxmox : Certificat Let's Encrypt avec challenge DNS","type":"posts"},{"content":"","date":"30 octobre 2024","externalUrl":null,"permalink":"/fr/tags/system/","section":"Tags","summary":"","title":"System","type":"tags"},{"content":"","date":"30 octobre 2024","externalUrl":null,"permalink":"/fr/tags/","section":"Tags","summary":"","title":"Tags","type":"tags"},{"content":"","externalUrl":null,"permalink":"/fr/authors/","section":"Authors","summary":"","title":"Authors","type":"authors"},{"content":"","externalUrl":null,"permalink":"/fr/categories/","section":"Categories","summary":"","title":"Categories","type":"categories"},{"content":"","externalUrl":null,"permalink":"/fr/series/","section":"Series","summary":"","title":"Series","type":"series"}]